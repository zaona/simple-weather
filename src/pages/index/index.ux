<template>
  <!-- é¡µé¢å®¹å™¨ -->
  <div class="page">
    <!-- èƒŒæ™¯å›¾ç‰‡ -->
    <image class="page-bg" src="/common/weather-bgs/{{ backgroundImage }}.png" />

    <!-- åŠ è½½åŠ¨ç”»å®¹å™¨ -->
    <div class="loading-container" if="{{ isLoading }}">
      <div class="loading-bg"></div>
      <image class="loading-icon" src="/common/loading.png" />
    </div>

    <scroll class="main" scroll-y="true" bounces="true" style="position: fixed; top: 0; bottom: 0" if="{{ !isLoading }}">
      <!-- å¤´éƒ¨ä¿¡æ¯ï¼šåœ°ç‚¹å’Œæ›´æ–°æ—¶é—´ -->
      <div class="header">
        <text class="page-title">{{ location }}</text>
        <text class="page-subtitle">{{ updateTime }}</text>
      </div>

      <!-- å½“å‰å¤©æ°”æ¦‚è§ˆ -->
      <div class="hero-content">
        <image class="weather-icon" src="/common/weather-icons/{{ iconCode }}.png" />
        <text class="weather-text">{{ textDay }}</text>
        <text class="temp-min-max">{{ tempMinMax }}</text>
      </div>

      <!-- å¤©æ°”æŒ‡æ ‡é¢æ¿ -->
      <div class="page-list" style="margin-top: 28px">
        <div style="margin-top: -2px; flex-direction: column">
          <div style="margin-top: 14px; flex-direction: column" for="{{ item in figure }}">
            <text class="figure-desc">{{ item.value }}</text>
            <text class="figure-title">{{ item.name }}</text>
          </div>
        </div>
      </div>

      <!-- æœªæ¥å‡ å¤©å¤©æ°”é¢„æŠ¥ -->
      <div class="page-list" style="margin-top: 12px">
        <div style="margin-top: -8px; flex-direction: column">
          <div class="day-weather-item" for="{{ item in dayWeather }}" @click="DetailInfo(item)">
            <text class="day-weather-title">{{ item.name }}</text>
            <div style="justify-content: space-between">
              <text class="day-weather-desc">{{ item.tempMinMax }}</text>
              <image
                class="small-weather-icon"
                src="/common/weather-icons/{{ item.iconCode }}.png"
              />
            </div>
          </div>
        </div>
      </div>
      <div class="hero-content" style="margin-top: 24px">
        <div class="button" onclick="About()">
          <text class="button-text">å…³äº</text>
        </div>
      </div>
    </scroll>
  </div>
</template>

<script>
// å¯¼å…¥ç³»ç»Ÿæ¨¡å—
import router from "@system.router"
import { showToast } from "@system.prompt"

// å¯¼å…¥æœåŠ¡å±‚
import DataService from "../../services/data-service.js"
import ConnectionService from "../../services/connection-service.js"
import DebugService from "../../services/debug-service.js"
import { MESSAGES, TOAST_DURATION } from "../../services/config.js"

// å¯¼å…¥å·¥å…·ç±»
import { DateUtils, WeatherDataUtils } from "../../common/weather-utils.js"

export default {
  // é¡µé¢ç§æœ‰æ•°æ®
  private: {
    isLoading: true, // åŠ è½½çŠ¶æ€
    isFirstLoad: true, // æ˜¯å¦æ˜¯é¦–æ¬¡åŠ è½½
    location: "__", // åœ°ç‚¹
    updateTime: "__", // æ›´æ–°æ—¶é—´
    iconCode: "__", // å¤©æ°”å›¾æ ‡ä»£ç 
    textDay: "__", // ç™½å¤©å¤©æ°”æè¿°
    tempMinMax: "__Â°/__Â°", // æœ€é«˜/æœ€ä½æ¸©åº¦
    backgroundImage: "", // èƒŒæ™¯å›¾ç‰‡

    // å¤©æ°”æŒ‡æ ‡æ•°æ®
    figure: [
      { name: "ç´«å¤–çº¿æŒ‡æ•°", value: "__", uniqueId: 1 },
      { name: "ç›¸å¯¹æ¹¿åº¦ ï¼ˆ%ï¼‰", value: "__", uniqueId: 2 },
      { name: "__", value: "__", uniqueId: 3 },
      { name: "æ°”å‹ ï¼ˆhPaï¼‰", value: "__", uniqueId: 4 }
    ],

    // æœªæ¥å‡ å¤©å¤©æ°”é¢„æŠ¥æ•°æ®
    dayWeather: [{ name: "__", tempMinMax: "__", iconCode: "__", uniqueId: 1 }]
  },

  /**
   * è·³è½¬åˆ°è¯¦æƒ…é¡µ
   * @param {Object} selectedItem - é€‰ä¸­çš„å¤©æ°”é¡¹
   */
  DetailInfo(selectedItem) {
    if (selectedItem && selectedItem.fxDate) {
      router.push({
        uri: "/pages/detail",
        params: {
          selectedDate: selectedItem.fxDate
        }
      })
    } else {
      showToast({ 
        message: MESSAGES.NAVIGATION_ERROR, 
        duration: TOAST_DURATION.NORMAL 
      })
    }
  },

  /**
   * è·³è½¬åˆ°å…³äºé¡µ
   */
  About() {
    router.push({
      uri: "/pages/about"
    })
  },

  /**
   * åŠ è½½å¹¶æ˜¾ç¤ºå¤©æ°”æ•°æ®
   */
  async loadWeatherData() {
    const result = await DataService.getTodayData()

    if (!result) {
      // getTodayData å†…éƒ¨å·²ç»å¤„ç†äº†é”™è¯¯æç¤º
      return
    }

    const { weatherData, todayData } = result

    // è®¡ç®—æ›´æ–°æ—¶é—´
    const updateTime = new Date(weatherData.updateTime)
    const timeAgo = DateUtils.formatTimeAgo(updateTime)

    // æ›´æ–°ç•Œé¢æ•°æ®
    WeatherDataUtils.updateCurrentWeather(this, weatherData, todayData, timeAgo)
    this.location = weatherData.location || "æœªçŸ¥åœ°ç‚¹"
    this.figure = WeatherDataUtils.getBasicWeatherFigures(todayData)
    this.dayWeather = WeatherDataUtils.processForecastData(weatherData)
  },

  /**
   * é¡µé¢åˆå§‹åŒ–
   */
  async onInit() {
    // ğŸ”§ è°ƒè¯•æ¨¡å¼ï¼šæ³¨å…¥æ¨¡æ‹Ÿæ•°æ®ï¼ˆå¯é€‰ï¼‰
    // å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¯å¯ç”¨æ¨¡æ‹Ÿæ•°æ®æ³¨å…¥
    // await DebugService.injectMockData()

    // åŠ è½½æœ¬åœ°æ•°æ®
    await this.loadWeatherData()

    // é¦–æ¬¡åŠ è½½å®Œæˆï¼Œéšè—åŠ è½½åŠ¨ç”»
    if (this.isFirstLoad) {
      this.isLoading = false
      this.isFirstLoad = false
    }
  },

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶åˆå§‹åŒ–è¿æ¥
   */
  onShow() {
    // åˆå§‹åŒ–è¿æ¥å¹¶æ³¨å†Œæ¶ˆæ¯å¤„ç†
    ConnectionService.init((data) => {
      this.handleWeatherData(data)
    })
  },

  /**
   * å¤„ç†æ¥æ”¶åˆ°çš„å¤©æ°”æ•°æ®
   * @param {Object} data - æ¥æ”¶åˆ°çš„æ•°æ®
   */
  async handleWeatherData(data) {
    try {
      // è§£ææ•°æ®
      const weatherData = JSON.parse(data.data)

      // éªŒè¯æ•°æ®æ ¼å¼
      if (!DataService.validateWeatherData(weatherData)) {
        showToast({ 
          message: MESSAGES.DATA_FORMAT_ERROR, 
          duration: TOAST_DURATION.NORMAL 
        })
        this.isLoading = false
        return
      }

      // è®¡ç®—æ›´æ–°æ—¶é—´
      const updateTime = new Date(weatherData.updateTime)
      const timeAgo = DateUtils.formatTimeAgo(updateTime)
      const todayStr = DateUtils.getTodayString()

      // æŸ¥æ‰¾ä»Šå¤©çš„æ•°æ®
      const todayData = weatherData.daily.find(day => day.fxDate === todayStr)

      if (!todayData) {
        showToast({ 
          message: MESSAGES.DATA_MISSING, 
          duration: TOAST_DURATION.NORMAL 
        })
        return
      }

      // æ›´æ–°ç•Œé¢
      WeatherDataUtils.updateCurrentWeather(this, weatherData, todayData, timeAgo)
      this.location = weatherData.location || "æœªçŸ¥åœ°ç‚¹"
      this.figure = WeatherDataUtils.getBasicWeatherFigures(todayData)
      this.dayWeather = WeatherDataUtils.processForecastData(weatherData)

      // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
      await DataService.saveWeatherData(data.data)

      showToast({ 
        message: MESSAGES.DATA_UPDATED, 
        duration: TOAST_DURATION.SHORT 
      })

    } catch (e) {
      showToast({ 
        message: MESSAGES.DATA_PARSE_ERROR, 
        duration: TOAST_DURATION.NORMAL 
      })
      console.error("æ•°æ®è§£æå¤±è´¥:", e)
    } finally {
      this.isLoading = false
      ConnectionService.resetConnectionState()
    }
  },

  /**
   * é¡µé¢éšè—æ—¶å…³é—­è¿æ¥
   */
  onHide() {
    ConnectionService.close()
  },

  /**
   * é¡µé¢é”€æ¯æ—¶å…³é—­è¿æ¥
   */
  onDestroy() {
    ConnectionService.close()
  }
}
</script>

<style>
/* å¼•å…¥å…¬å…±æ ·å¼ */
@import "../../common/style.css";
@import "../../common/loading-styles.css";
@import "../../common/page-bg-styles.css";

/* é¡µé¢ç‰¹å®šæ ·å¼ */
.page {
  flex-direction: column;
  align-items: center;
  position: relative;
}

.main {
  position: relative;
  z-index: 1;
}

.day-weather-item {
  margin-top: 16px;
  flex-direction: column;
}

.day-weather-title {
  font-size: 28px;
  color: rgba(255, 255, 255, 0.8);
}

.day-weather-desc {
  font-size: 32px;
}

.small-weather-icon {
  width: 48px;
  height: 48px;
}
</style>
