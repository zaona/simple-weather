<template>
  <!-- é¡µé¢å®¹å™¨ -->
  <div class="page-container">
    <!-- èƒŒæ™¯å›¾ç‰‡ -->
    <image class="page-bg" src="/common/weather-bgs/{{ backgroundImage }}.png" />

    <!-- åŠ è½½åŠ¨ç”»å®¹å™¨ -->
    <div class="loading-container" if="{{ isLoading }}">
      <div class="loading-bg"></div>
      <image class="loading-icon" src="/common/loading.png" />
    </div>

    <scroll class="main-content scroll-container" scroll-y="true" bounces="true" if="{{ !isLoading }}">
      <!-- å¤´éƒ¨ä¿¡æ¯ï¼šåœ°ç‚¹å’Œæ›´æ–°æ—¶é—´ -->
      <div class="page-header">
        <text class="text-location">{{ location }}</text>
        <text class="text-subtitle">{{ updateTime }}</text>
      </div>

      <!-- å½“å‰å¤©æ°”æ¦‚è§ˆ -->
      <div class="content-hero card-margin">
        <image class="icon-weather-main" src="/common/weather-icons/{{ iconCode }}.png" />
        <text class="text-weather">{{ textDay }}</text>
        <text class="text-temp-range">{{ tempMinMax }}</text>
      </div>

      <!-- å¤©æ°”æŒ‡æ ‡é¢æ¿ -->
      <div class="card card-double">
        <div class="item-data" for="{{ item in figure }}">
        <text class="text-data-value">{{ item.value }}{{ item.unit }}</text>
        <text class="text-data-label">{{ item.name }}</text>
      </div>
    </div>

      <!-- æœªæ¥å‡ å¤©å¤©æ°”é¢„æŠ¥ -->
      <div class="card card-single">
        <div class="flex-col mt-negative-sm">
          <div class="item-forecast" for="{{ item in dayWeather }}" @click="DetailInfo(item)">
            <text class="text-date">{{ item.name }}</text>
            <div class="justify-between">
              <text class="text-weather-desc">{{ item.tempMinMax }}</text>
              <image
                class="icon-weather-small"
                src="/common/weather-icons/{{ item.iconCode }}.png"
              />
            </div>
          </div>
        </div>
      </div>

      <div class="content-hero mt-lg">
        <div class="btn-primary" onclick="About()">
          <text class="text-button">å…³äº</text>
        </div>
      </div>
    </scroll>
  </div>
</template>

<script>
// å¯¼å…¥ç³»ç»Ÿæ¨¡å—
import router from "@system.router"
import { showToast } from "@system.prompt"

// å¯¼å…¥æœåŠ¡å±‚
import DataService from "../../services/data-service.js"
import ConnectionService from "../../services/connection-service.js"
import DebugService from "../../services/debug-service.js"
import { MESSAGES, TOAST_DURATION } from "../../services/config.js"

// å¯¼å…¥å·¥å…·ç±»
import { DateUtils, WeatherDataUtils } from "../../common/weather-utils.js"

export default {
  // é¡µé¢ç§æœ‰æ•°æ®
  private: {
    isLoading: true, // åŠ è½½çŠ¶æ€
    isFirstLoad: true, // æ˜¯å¦æ˜¯é¦–æ¬¡åŠ è½½
    location: "__", // åœ°ç‚¹
    updateTime: "__", // æ›´æ–°æ—¶é—´
    iconCode: "__", // å¤©æ°”å›¾æ ‡ä»£ç 
    textDay: "__", // ç™½å¤©å¤©æ°”æè¿°
    tempMinMax: "__Â°/__Â°", // æœ€é«˜/æœ€ä½æ¸©åº¦
    backgroundImage: "", // èƒŒæ™¯å›¾ç‰‡

    // å¤©æ°”æŒ‡æ ‡æ•°æ®
    figure: [
  { name: "ç´«å¤–çº¿æŒ‡æ•°", value: "__", unit: "", uniqueId: 1 },
  { name: "ç›¸å¯¹æ¹¿åº¦", value: "__", unit: "%", uniqueId: 2 },
  { name: "__", value: "__", unit: "", uniqueId: 3 },
  { name: "æ°”å‹", value: "__", unit: "hPa", uniqueId: 4 }
],


    // æœªæ¥å‡ å¤©å¤©æ°”é¢„æŠ¥æ•°æ®
    dayWeather: [{ name: "__", tempMinMax: "__", iconCode: "__", uniqueId: 1 }]
  },

  /**
   * è·³è½¬åˆ°è¯¦æƒ…é¡µ
   * @param {Object} selectedItem - é€‰ä¸­çš„å¤©æ°”é¡¹
   */
  DetailInfo(selectedItem) {
    if (selectedItem && selectedItem.fxDate) {
      router.push({
        uri: "/pages/detail",
        params: {
          selectedDate: selectedItem.fxDate
        }
      })
    } else {
      showToast({ 
        message: MESSAGES.NAVIGATION_ERROR, 
        duration: TOAST_DURATION.NORMAL 
      })
    }
  },

  /**
   * è·³è½¬åˆ°å…³äºé¡µ
   */
  About() {
    router.push({
      uri: "/pages/about"
    })
  },

  /**
   * åŠ è½½å¹¶æ˜¾ç¤ºå¤©æ°”æ•°æ®
   * @param {boolean} silent - é™é»˜æ¨¡å¼ï¼Œä¸æ˜¾ç¤ºé”™è¯¯Toast
   * @returns {Object} è¿”å› { success: boolean, status: string }
   */
  async loadWeatherData(silent = false) {
    const result = await DataService.getTodayData(silent)

    // æ£€æŸ¥åŠ è½½çŠ¶æ€
    if (!result || result.status !== 'success') {
      return { 
        success: false, 
        status: result?.status || 'unknown' 
      }
    }

    const { weatherData, todayData } = result

    // è®¡ç®—æ›´æ–°æ—¶é—´
    const updateTime = new Date(weatherData.updateTime)
    const timeAgo = DateUtils.formatTimeAgo(updateTime)

    // æ›´æ–°ç•Œé¢æ•°æ®
    WeatherDataUtils.updateCurrentWeather(this, weatherData, todayData, timeAgo)
    this.location = weatherData.location || "æœªçŸ¥åœ°ç‚¹"
    this.figure = WeatherDataUtils.getBasicWeatherFigures(todayData)
    this.dayWeather = WeatherDataUtils.processForecastData(weatherData)
    
    return { success: true, status: 'success' }
  },

  /**
   * é¡µé¢åˆå§‹åŒ–
   */
  async onInit() {
    // ğŸ”§ è°ƒè¯•æ¨¡å¼ï¼šæ³¨å…¥æ¨¡æ‹Ÿæ•°æ®ï¼ˆå¯é€‰ï¼‰
    // å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¯å¯ç”¨æ¨¡æ‹Ÿæ•°æ®æ³¨å…¥
    // await DebugService.injectMockData()

    // åŠ è½½æœ¬åœ°æ•°æ®ï¼ˆé™é»˜æ¨¡å¼ï¼‰
    const result = await this.loadWeatherData(true)

    // é¦–æ¬¡åŠ è½½å®Œæˆ
    if (this.isFirstLoad) {
      if (result.success) {
        // æœ‰æ•°æ®ï¼Œå…³é—­åŠ è½½åŠ¨ç”»
        this.isLoading = false
      } else {
        // æ— æ•°æ®æˆ–æ•°æ®è¿‡æœŸï¼Œä¿æŒåŠ è½½åŠ¨ç”»ï¼Œæ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæç¤º
        let toastMessage = MESSAGES.WAITING_FOR_FIRST_DATA
        
        if (result.status === 'expired') {
          toastMessage = MESSAGES.WAITING_FOR_UPDATE
        } else if (result.status === 'no_data') {
          toastMessage = MESSAGES.WAITING_FOR_FIRST_DATA
        }
        
        showToast({ 
          message: toastMessage, 
          duration: TOAST_DURATION.LONG 
        })
        // ä¸å…³é—­ isLoadingï¼Œç­‰å¾… handleWeatherData æ¥æ”¶æ•°æ®åå…³é—­
      }
      this.isFirstLoad = false
    }
  },

  /**
   * é¡µé¢æ˜¾ç¤ºæ—¶åˆå§‹åŒ–è¿æ¥
   */
  onShow() {
    // åˆå§‹åŒ–è¿æ¥å¹¶æ³¨å†Œæ¶ˆæ¯å¤„ç†
    ConnectionService.init((data) => {
      this.handleWeatherData(data)
    })
  },

  /**
   * å¤„ç†æ¥æ”¶åˆ°çš„å¤©æ°”æ•°æ®
   * @param {Object} data - æ¥æ”¶åˆ°çš„æ•°æ®
   */
  async handleWeatherData(data) {
    try {
      // è§£ææ•°æ®
      const weatherData = JSON.parse(data.data)

      // éªŒè¯æ•°æ®æ ¼å¼
      if (!DataService.validateWeatherData(weatherData)) {
        showToast({ 
          message: MESSAGES.DATA_FORMAT_ERROR, 
          duration: TOAST_DURATION.NORMAL 
        })
        this.isLoading = false
        return
      }

      // è®¡ç®—æ›´æ–°æ—¶é—´
      const updateTime = new Date(weatherData.updateTime)
      const timeAgo = DateUtils.formatTimeAgo(updateTime)
      const todayStr = DateUtils.getTodayString()

      // æŸ¥æ‰¾ä»Šå¤©çš„æ•°æ®
      const todayData = weatherData.daily.find(day => day.fxDate === todayStr)

      if (!todayData) {
        showToast({ 
          message: MESSAGES.DATA_MISSING, 
          duration: TOAST_DURATION.NORMAL 
        })
        return
      }

      // æ›´æ–°ç•Œé¢
      WeatherDataUtils.updateCurrentWeather(this, weatherData, todayData, timeAgo)
      this.location = weatherData.location || "æœªçŸ¥åœ°ç‚¹"
      this.figure = WeatherDataUtils.getBasicWeatherFigures(todayData)
      this.dayWeather = WeatherDataUtils.processForecastData(weatherData)

      // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
      await DataService.saveWeatherData(data.data)

      showToast({ 
        message: MESSAGES.DATA_UPDATED, 
        duration: TOAST_DURATION.SHORT 
      })

    } catch (e) {
      showToast({ 
        message: MESSAGES.DATA_PARSE_ERROR, 
        duration: TOAST_DURATION.NORMAL 
      })
      console.error("æ•°æ®è§£æå¤±è´¥:", e)
    } finally {
      this.isLoading = false
      ConnectionService.resetConnectionState()
    }
  },

  /**
   * é¡µé¢éšè—æ—¶å…³é—­è¿æ¥
   */
  onHide() {
    ConnectionService.close()
  },

  /**
   * é¡µé¢é”€æ¯æ—¶å…³é—­è¿æ¥
   */
  onDestroy() {
    ConnectionService.close()
  }
}
</script>

<style>
/* å¼•å…¥å…¬å…±æ ·å¼ */
@import "../../common/css/style.css";
@import "../../common/css/loading-styles.css";
@import "../../common/css/page-bg-styles.css";
</style>
